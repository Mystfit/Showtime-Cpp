# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|
  
  guest_source_path = "/vagrant-showtime-src"

  config.vm.box = "sylabs/singularity-3.2-ubuntu-bionic64"
  config.vm.box_version = "20190515.0.0"
  config.vm.synced_folder "${CMAKE_SOURCE_DIR}", guest_source_path
  config.vm.synced_folder "${ANDROID_BINARY_PATH}", "/vagrant-showtime-bin-output"
  config.vm.synced_folder "${ANDROID_LIBRARY_PATH}", "/vagrant-showtime-lib-output"
  config.vm.define "${ANDROID_CONTAINER_NAME}"

  config.vm.provider "virtualbox" do |vb|
    vb.gui = false
    vb.cpus = ${CONTAINER_CPU_COUNT}  
    vb.memory = "${CONTAINER_MEMORY_AMOUNT}"
  end

  env_vars = {
    "SHOWTIME_SOURCE" => "/vagrant-showtime-src",
    "SHOWTIME_BUILD" => "/vagrant-showtime-build",
    "SHOWTIME_BIN_OUTPUT" => "/vagrant-showtime-bin-output",
    "SHOWTIME_LIB_OUTPUT" => "/vagrant-showtime-lib-output",
    "VM_DIR" => "/VMs"
  }
  
  # Setup container
  config.vm.provision :shell, env: env_vars, inline: <<-SHELL
    sudo mkdir -p $VM_DIR
    sudo mkdir -p $SHOWTIME_BUILD
    yes | sudo singularity build $VM_DIR/build-android.sif $SHOWTIME_SOURCE/containers/android/build-android.def
  SHELL

  # Build android libs
  config.vm.provision :shell, env: env_vars, run: 'always', path: "${CMAKE_SOURCE_DIR}/containers/android/build_singularity_android.sh"
end

