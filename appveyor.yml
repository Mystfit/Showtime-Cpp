version: '{build}'

branches:
  only:
  - master
  - develop
  - appveyor

only_commits:
  files:
    - CMakeLists.txt
    - appveyor.yml
    - .appveyor/
    - src/
    - include/

cache: 
#- dependencies
- dependencies -> .appveyor/cleanup-appveyor-cache.txt

clone_folder: C:/projects/showtime-cpp

image:
- Visual Studio 2017

configuration:
- Debug
- Release

platform:
- x64

environment:
    GENERATOR: "Visual Studio 15 2017 Win64"
    BOOST_ROOT: "C:/Libraries/boost_1_67_0"
    BUILD_FOLDER: "%APPVEYOR_BUILD_FOLDER%/build"
    DEPENDENCY_DIR: "%APPVEYOR_BUILD_FOLDER%/dependencies"
    INSTALL_DIR: "%APPVEYOR_BUILD_FOLDER%/install"
    matrix:
    - PYTHON_VER: 2.7
    - PYTHON_VER: 3.7

matrix:
    fast_finish: true

install:
- cmd: |-
    mkdir build
    call %APPVEYOR_BUILD_FOLDER%/install_dependencies.bat --build-dir %BUILD_FOLDER% --config %CONFIGURATION%

before_build:
- cmd: |-
    set CMAKE_FLAGS=%CMAKE_FLAGS% -DCMAKE_PREFIX_PATH="%DEPENDENCY_DIR%/install;%DEPENDENCY_DIR%/swig;${CMAKE_PREFIX_PATH}"
    set CMAKE_BIN=%DEPENDENCY_DIR%/cmake/bin/cmake
    set CTEST_BIN=%DEPENDENCY_DIR%/cmake/bin/ctest
    set CMAKE_FLAGS=%CMAKE_FLAGS% -DBINDINGS_DOTNET=ON -DBINDINGS_DOTNET_TESTS=ON -DBINDINGS_DOTNET_FRAMEWORK_VERSION=v4.7.2
    set CMAKE_FLAGS=%CMAKE_FLAGS% -DBINDINGS_PYTHON=ON -DBINDINGS_PYTHON_TESTS=ON -DBINDINGS_DOTNET_VERSION=%PYTHON_VER%
    set CMAKE_FLAGS=%CMAKE_FLAGS% -DCMAKE_INSTALL_PREFIX=%INSTALL_DIR%
    set CMAKE_FLAGS=%CMAKE_FLAGS% -DBUILD_SHARED=ON -DBUILD_STATIC=ON -DBUILD_DRAFTS=ON
    set CMAKE_FLAGS=%CMAKE_FLAGS% -DBOOST_ROOT:PATHNAME="%BOOST_ROOT%" -DBOOST_INCLUDEDIR:PATHNAME="%BOOST_ROOT%" -DBOOST_LIBRARYDIR:PATHNAME="%BOOST_ROOT%/lib64-msvc-14.1"
    %CMAKE_BIN% -H. -B"%BUILD_FOLDER%" -G "%GENERATOR%" %CMAKE_FLAGS%

build:
  parallel: true
  project: $(BUILD_FOLDER)/Showtime.sln
  verbosity: minimal

test_script:
- ps: |
    Push-Location -Path "$env:BUILD_FOLDER"
    & $env:CTEST_BIN -C $env:CONFIGURATION --output-on-fail --no-compress-output -T Test -j 2 --timeout 320
    $result = Get-Childitem -ErrorAction SilentlyContinue -Recurse â€“Path $env:BUILD_FOLDER/Testing/*.xml
    $XSLInputElement = New-Object System.Xml.Xsl.XslCompiledTransform
    $XSLInputElement.Load("https://raw.githubusercontent.com/rpavlik/jenkins-ctest-plugin/master/ctest-to-junit.xsl")
    $XSLInputElement.Transform($result[0].FullName, (Join-Path (Resolve-Path .) "ctest-to-junit-results.xml"))
    $wc = New-Object 'System.Net.WebClient'
    $wc.UploadFile("https://ci.appveyor.com/api/testresults/junit/$($env:APPVEYOR_JOB_ID)", (Resolve-Path .\ctest-to-junit-results.xml))
    Pop-Location
