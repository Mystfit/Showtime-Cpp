branches:
  only:
  - master
  - develop
  - travis

sudo: false 

os: 
  - linux
  - osx
dist: xenial
osx_image: xcode10.1

addons: &common_build
  apt:
    packages:
      - curl
  homebrew:
    brewfile: true
    update: true

matrix:
  include:
    - stage: build
      language: cpp
      env:
        - BUILD_TYPE=Debug
        - BUILD_TYPE=Release
      cache:
        - directories:
          - $TRAVIS_BUILD_DIR/install
    - stage: test
      language: python
      env: BUILD_TYPE=Release
    - stage: test
      language: ruby
      env: BUILD_TYPE=Release
    - stage: test
      language: csharp
      env: BUILD_TYPE=Release
      homebrew:
        casks:
        - dotnet-sdk

before_install:
  # Set common env variables
  - if [ "$TRAVIS_OS_NAME" == "osx" ]; then
      export PREFIX=/usr/local;
      echo $(which brew);
      echo $PATH;
    fi

  # Create linuxbrew prefix
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      export PREFIX=/home/linuxbrew/.linuxbrew;
    fi

  # Set prefix search path to homebrew folder for library discovery
  - GENERATOR_ARGS="$GENERATOR_ARGS -DCMAKE_PREFIX_PATH=$PREFIX;${CMAKE_PREFIX_PATH}"

install:
  # Output something every 10 minutes or Travis kills the job
  - while sleep 9m; do echo "=====[ $SECONDS seconds still running ]====="; done &

  # Install linuxbrew dependencies
  - if [ "$TRAVIS_OS_NAME" == "linux" ]; then
      export PATH=$PREFIX/bin:$PREFIX/sbin:$PATH;
      export MANPATH=$PREFIX/share/man:$MANPATH;
      export INFOPATH=$PREFIX/share/info:$INFOPATH;
      sh -c "$(curl -fsSL https://raw.githubusercontent.com/Linuxbrew/install/master/install.sh)";
      hash -r;
      echo $(which brew);
      echo $PATH;
    fi

  # Install homebrew dependencies
  - brew update
  - brew bundle || true

  # Kill background sleep loop
  - kill %1

script:
  # Set installation prefix
  - GENERATOR_ARGS="$GENERATOR_ARGS -DCMAKE_INSTALL_PREFIX=$TRAVIS_BUILD_DIR/install"

  # Set prefix search path to homebrew folder for library discovery
  - GENERATOR_ARGS="$GENERATOR_ARGS -DCMAKE_PREFIX_PATH=$PREFIX;${CMAKE_PREFIX_PATH}"

  # Python bindings
  - GENERATOR_ARGS="$GENERATOR_ARGS -DBINDINGS_PYTHON=ON -DBINDINGS_PYTHON_TESTS=ON -DPYTHON_EXECUTABLE=$PYTHON_BIN"

  # Shared and static libraries
  - GENERATOR_ARGS="$GENERATOR_ARGS -DBUILD_SHARED=ON -DBUILD_STATIC=ON"

  # Build and install project
  - cmake -H$TRAVIS_BUILD_DIR -B$TRAVIS_BUILD_DIR/build -G "$GENERATOR" $GENERATOR_ARGS
  - cmake --build $TRAVIS_BUILD_DIR/build --config $CONFIG
  - cmake --build $TRAVIS_BUILD_DIR/build --target install --config $CONFIG

  # Run tests
  - pushd $TRAVIS_BUILD_DIR/build
  - ctest -C $CONFIG --output-on-fail --no-compress-output -T Test --timeout 320
