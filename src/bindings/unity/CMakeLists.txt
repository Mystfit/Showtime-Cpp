message(STATUS "Building ${UNITY_TARGET} target")

set(UNITY_EXECUTABLE $ENV{PROGRAMFILES}/Unity/Editor/Unity.exe CACHE FILEPATH "Path to Unity executable")
set(UNITY_BUILD_PROJECT ${CMAKE_SWIG_ROOT_OUTDIR}/unity)

# Copy unity project to build dir
file(COPY "${CMAKE_CURRENT_LIST_DIR}/unity" DESTINATION ${CMAKE_SWIG_ROOT_OUTDIR})

# Set Unity project paths
SET(DOTNET_LIB_OUTPUT $<TARGET_FILE:${SWIG_MODULE_${DOTNET_TARGET}_REAL_NAME}>)
SET(UNITY_BIN_DIR ${UNITY_BUILD_PROJECT}/Assets/${UNITY_TARGET}/Plugins/x64-win)
SET(UNITY_BINDINGS_DIR ${UNITY_BUILD_PROJECT}/Assets/${UNITY_TARGET}/Plugins/bindings)
set(UNITY_BINARY_FILES 
    $<TARGET_FILE:${CORE_TARGET}> 
    $<TARGET_FILE:${CLIENT_TARGET}> 
    $<TARGET_FILE:${SERVER_TARGET}> 
    ${DOTNET_LIB_OUTPUT} 
    ${RUNTIMES_LOG4CPLUS}
    ${RUNTIMES_LIBZMQ}
    ${RUNTIMES_CZMQ}
)

add_custom_command(
    OUTPUT ${BUILD_STAMP} 
    COMMAND ${CMAKE_COMMAND} -E make_directory ${UNITY_BINDINGS_DIR}
    COMMAND ${CMAKE_COMMAND} -E make_directory ${UNITY_BIN_DIR}
    COMMAND ${CMAKE_COMMAND} -E copy ${DOTNET_GENERATED_BINDINGS} ${UNITY_BINDINGS_DIR}
    COMMAND ${CMAKE_COMMAND} -E copy ${UNITY_BINARY_FILES} ${UNITY_BIN_DIR}
    COMMAND ${UNITY_EXECUTABLE} -batchmode -quit -projectPath ${UNITY_BUILD_PROJECT} -exportPackage Assets/${UNITY_TARGET} ${UNITY_TARGET}-${SHOWTIME_VERSION}.unitypackage
    DEPENDS ${DOTNET_TARGET} ${SERVER_TARGET}
)
add_custom_target(${UNITY_TARGET} ALL DEPENDS ${BUILD_STAMP})
